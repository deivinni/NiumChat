<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Node chat</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <p id="note">VocÃª pode digitar <strong class="command">/clear</strong> para limpar as mensagens.</p>
    <div id="squares" class="flex">
        <div class="square purple"></div>
        <div class="square crimson"></div>
        <div class="square wheat"></div>
        <div class="square green"></div>
        <div class="square blue"></div>
    </div>
    <div id="chat">
        <div class="messages"></div>
        <form id="text-box" class="flex">
            <input id="message" type="text" name="message" autocomplete="off" placeholder="Digite sua mensagem">
            <button type="submit">Enviar</button>
        </form>
    </div>

    <script type="text/javascript" defer>
        // const address = 'http://localhost:3000';
        const address = 'https://nium-chat.herokuapp.com';
        const socket = io(address);

        for (square of document.getElementsByClassName('square')) {
            square.addEventListener('click', (square) => {
                const root = document.querySelector(':root');
                square = window.getComputedStyle(square.target);
            
                root.style.setProperty('--border', square.getPropertyValue('border-color'));
                root.style.setProperty('--background', square.getPropertyValue('background-color'));
            });
        }
        
        const getCookie = (name) => {
            const nameEQ = `${name}=`;
            const cookieArray = document.cookie.split(';');
            
            for (let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i];
                
                while (cookie.chatAt(0) == ' ') cookie = cookie.substring(1, cookie.length);
                
                if (cookie.indexOf(nameEQ) == 0) return cookie.substring(nameEQ.length, cookie.length);
            }
            
            return null;
        };
        const getName = () => getCookie('chatUsername') || socket.id;
        const updateScroll = () => $('.messages').animate({ scrollTop: $('.messages').prop('scrollHeight') }, 500);
        const addMessageRendered = (html) => $('.messages').append(html);
        const renderUsername = (name) => {
            const today = new Date();
            const minutes = today.getMinutes();

            name = `${name} at ${today.getHours()}:${minutes <= 9? '0' + minutes : minutes}`;
            return `<h5 class='username'>${name}</h5>`;
        };
        const renderMessageContent = (string) => `<p>${string.replace(new RegExp(/\@([a-zA-Z0-9]+)/gm), (item) => `<span class='mention'>${item}</span>`)}</p>`;
        const renderMessage = (message) => {
            addMessageRendered([
                '<div class="message">',
                    `<img class="user-image" src="${message.author.avatar_url}">`,
                    `<div cladd="content">${renderUsername(message.author.name)}${renderMessageContent(message.content)}</div>`,
                '</div>'
            ].join(''));
            
            return updateScroll();
        }
        const playAudioNotification = (path) => new Audio(`./${path}.ogg`).play();

        socket
            .on('messageNotSended', () => {})
            .on('receivedMessage', (message) => {
                renderMessage(message);
                console.log(message.mentions);
            
                return playAudioNotification(message.mentions.includes(`@${getName()}`) ? 'mention' : 'message');
            })
            .on('messageSended', (message) => {
                document.getElementById('message').value = '';
                renderMessage(message);
            });

        $('#chat').submit((event) => {
            event.preventDefault();
            const message = $('input[name=message]').val();

            if (message.length) {
                if (message === '/clear') return $('.messages').html('');

                return socket.emit('sendMessage', {
                    author: {
                        name: getName(),
                        avatar_url: getCookie('chatAvatarUrl')
                    },
                    content: message
                });
            }
        })
    </script>
</body>
</html>
